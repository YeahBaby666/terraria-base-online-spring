// ==========================================
// 1. CONFIGURACIÃ“N (BINDS)
// ==========================================
// Vinculamos nombres lÃ³gicos a teclas fÃ­sicas
Client.bind('Saltar', 'Space');
Client.bind('Agacharse', 'ControlLeft');
Client.bind('AccionPrincipal', 'LeftClick'); // Funciona para Mouse Izq y Toque en pantalla

console.log("ðŸŽ® Input System Listo. Prueba teclas, mouse y touch.");

window.onInputLoop = () => {
    
    // ==========================================
    // A. DETECTOR DE CUALQUIER TECLA (RAW - ONE SHOT)
    // ==========================================
    // Ãštil para escribir en chat, abrir menÃºs ocultos o debugear
    Client.frameKeys.forEach(code => {
        console.log(`ðŸŽ¹ Tecla nueva detectada: ${code}`);
        
        if (code === 'KeyM') console.log("ðŸ—ºï¸ Abriendo Mapa (Detectado por Raw)");
        if (code === 'Escape') console.log("âš™ï¸ Pausando Juego");
    });

    // ==========================================
    // B. TECLAS MANTENIDAS POR ALIAS (isPress)
    // ==========================================
    // Devuelve TRUE mientras mantengas la tecla pulsada
    
    if (Client.isPress('Saltar')) {
        // Ejemplo: Cargar una barra de fuerza
        console.log("ðŸ”‹ Cargando potencia de salto...");
    }

    if (Client.isPress('Agacharse')) {
        console.log("ðŸ•µï¸ Caminando sigilosamente...");
    }

    // ==========================================
    // C. TECLAS ÃšNICAS POR ALIAS (isJustPressed)
    // ==========================================
    // Devuelve TRUE solo en el primer frame que presionas
    
    if (Client.isJustPressed('Saltar')) {
        console.log("ðŸ¦˜ Â¡EJECUTAR SALTO AHORA!");
        Client.emit('action_jump', {}); //Enviar el paquete al servidor: {} vacÃ­o por el momento
    }

    // ==========================================
    // D. TECLAS FÃSICAS MANTENIDAS (isKeyDown)
    // ==========================================
    // Si no quieres crear Binds y prefieres usar cÃ³digos directos (WASD)
    // Variables para recordar el Ãºltimo envÃ­o y no saturar la red
    // (Se guardan en window para persistir entre frames)
    
    window.lastSentmoveX = 0;
    window.lastSentmoveY = 0;
    
    let moveX = 0;
    let moveY = 0;

    if (Client.isKeyDown('KeyW') || Client.isKeyDown('ArrowUp'))    moveY = -1;
    if (Client.isKeyDown('KeyS') || Client.isKeyDown('ArrowDown'))  moveY = 1;
    if (Client.isKeyDown('KeyA') || Client.isKeyDown('ArrowLeft'))  moveX = -1;
    if (Client.isKeyDown('KeyD') || Client.isKeyDown('ArrowRight')) moveX = 1;
        
    // AquÃ­ es donde simulamos el evento "Soltar Tecla".
    // Si moveX pasa de 1 a 0, significa que soltaste la tecla.
    
    // Â¿Ha cambiado mi intenciÃ³n de movimiento desde el Ãºltimo paquete enviado?
    if (moveX !== window.lastSentmoveX || moveY !== window.lastSentmoveY ) {
        
        console.log(`ðŸ“¡ Cambio de Movimiento: X:${moveX} Y:${moveY}`);
        
        // Enviamos al servidor
        Client.emit('action_move', { vx: moveX , vy: moveY });
        
        // Actualizamos la memoria para no volver a enviar lo mismo en el siguiente frame
        window.lastSentmoveX = moveX;
        window.lastSentmoveY = moveY;  
        /*
        Presionas W -> Se envÃ­a {vy: -1} una sola vez.

	Mantienes W -> No se envÃ­a nada (el servidor asume que sigues moviÃ©ndote).

	Sueltas W -> vy vuelve a ser 0 (el "else implÃ­cito"). Es diferente al anterior (-1). Se envÃ­a {vy: 0} una sola vez.
       */
    }

    // ==========================================
    // E. MOUSE Y TOUCH (UNIFICADO)
    // ==========================================
    // El motor actualiza 'Client.worldMouse' tanto con el mouse como con el dedo
    const pointer = Client.worldMouse;

    // 1. Detectar "Clic" o "Toque" mantenido (RÃ¡faga)
    if (Client.isPress('AccionPrincipal')) {
        // Esto funciona si haces clic sostenido O si dejas el dedo en la pantalla
        console.log(`ðŸ”¥ Disparando rÃ¡faga hacia: ${Math.round(pointer.x)}, ${Math.round(pointer.y)}`);
    }

    // 2. Detectar "Clic" o "Toque" Ãºnico (Disparo preciso)
    if (Client.isJustPressed('AccionPrincipal')) {
        console.log(`ðŸ’¥ DISPARO ÃšNICO en X:${Math.round(pointer.x)} Y:${Math.round(pointer.y)}`);
        
        // Ejemplo: Crear efecto visual inmediato
        if (Client.spawnParticle) {
            Client.spawnParticle({ x: pointer.x, y: pointer.y, color: 'orange', speed: 8, life: 0.5 });
        }
        
        Client.emit('shoot_event', { x: pointer.x, y: pointer.y });
    }

    // 3. Clic Derecho (Solo Mouse generalmente)
    if (Client.isJustPressed('RightClick')) {
        console.log("ðŸ›¡ï¸ Bloquear / MenÃº Contextual");
    }
    
    // ==========================================
    // F. TECLAS ESPECIALES Y MODIFICADORES
    // ==========================================

    // 1. CORRER (Shift)
    // El engine detecta automÃ¡ticamente 'ShiftLeft' o 'ShiftRight' si pides 'Shift'
    if (Client.isPress('Shift')) {
        // LÃ³gica de juego: Si me muevo y presiono Shift -> Correr
        if (moveX !== 0 || moveY !== 0) { // moveX/Y definidos en secciÃ³n D
            console.log("ðŸ’¨ MODO CORRER ACTIVO");
            Client.emit('action_sprint', { active: true });
        }
    }

    // 2. AGACHARSE (Control)
    // AquÃ­ usamos el cÃ³digo fÃ­sico especÃ­fico para diferenciar izq/der si queremos
    if (Client.isKeyDown('ControlLeft')) {
        console.log("â¬‡ï¸ Agachado (Ctrl Izquierdo)");
    }

    // 3. TECLAS DE SISTEMA (Enter, Escape, Backspace)
    // Usamos frameKeys para detectar el "golpe" exacto sin configurar Binds
    Client.frameKeys.forEach(code => {
        
        if (code === 'Enter') {
            console.log("ðŸ’¬ [SISTEMA] Abrir caja de Chat");
            // Client.emit('ui_open_chat');
        }

        if (code === 'Escape') {
            console.log("âš™ï¸ [SISTEMA] Pausa / MenÃº Principal");
        }

        if (code === 'Tab') {
            console.log("ðŸ“Š [SISTEMA] Mostrar Scoreboard / Inventario");
            // return; // Evita el comportamiento por defecto del navegador si es necesario
        }
    });

    // ==========================================
    // G. DEBUG: MONITOR DE ESTADO
    // ==========================================
    // (Opcional) Descomenta esto para ver en tiempo real TODO lo que estÃ¡ presionado
    /*
    const allKeys = Object.keys(Client.inputState.keys).filter(k => Client.inputState.keys[k]);
    if (allKeys.length > 0) {
        console.log("Teclas Activas:", allKeys.join(', '));
    }
    */
};