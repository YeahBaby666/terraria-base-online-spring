<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>Engine IO - Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .glass-panel {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .floating {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .hidden-form {
            display: none;
        }

        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: white;
        }

        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #9ca3af;
        }

        /* Estilo para el scroll personalizado */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
            /* Azul translúcido */
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.8);
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 font-sans min-h-screen flex flex-col relative overflow-hidden">

    <!-- DECORACIÓN -->
    <div
        class="absolute top-0 left-0 w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20">
    </div>

    <!-- NAVBAR -->
    <nav
        class="relative z-10 w-full px-6 py-4 flex justify-between items-center glass-panel border-b-0 border-b-gray-800">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-cube text-3xl text-blue-500"></i>
            <span class="text-2xl font-bold tracking-wider">ENGINE<span class="text-blue-500">IO</span></span>
        </div>
        <div class="flex items-center gap-4">
            <div sec:authorize="isAuthenticated()" class="flex items-center gap-3">
                <div class="text-right hidden sm:block">
                    <p class="text-xs text-gray-400">Hola,</p>
                    <p class="font-bold text-blue-400" th:text="${#authentication.name}">Usuario</p>
                </div>
                <form th:action="@{/logout}" method="post">
                    <button class="text-red-400 hover:text-red-300"><i class="fa-solid fa-power-off"></i></button>
                </form>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="relative z-10 flex-1 flex items-center justify-center p-4">

        <!-- ========================================== -->
        <!-- VISTA ANÓNIMA (LOGIN / REGISTRO)           -->
        <!-- ========================================== -->
        <div sec:authorize="!isAuthenticated()" class="w-full max-w-md glass-panel rounded-2xl p-8 shadow-2xl relative">

            <!-- Mensajes Flash del Backend -->
            <div th:if="${successMessage}"
                class="bg-green-500/20 text-green-300 p-3 rounded mb-4 text-sm border border-green-500/50">
                <i class="fa-solid fa-check mr-1"></i> <span th:text="${successMessage}"></span>
            </div>
            <div th:if="${errorMessage}"
                class="bg-red-500/20 text-red-300 p-3 rounded mb-4 text-sm border border-red-500/50">
                <i class="fa-solid fa-triangle-exclamation mr-1"></i> <span th:text="${errorMessage}"></span>
            </div>
            <div th:if="${param.error}"
                class="bg-red-500/20 text-red-300 p-3 rounded mb-4 text-sm border border-red-500/50">
                <i class="fa-solid fa-triangle-exclamation mr-1"></i> Credenciales inválidas.
            </div>
            <div th:if="${param.logout}"
                class="bg-blue-500/20 text-blue-300 p-3 rounded mb-4 text-sm border border-blue-500/50">
                <i class="fa-solid fa-info-circle mr-1"></i> Sesión cerrada correctamente.
            </div>

            <!-- Tabs -->
            <div class="flex mb-6 border-b border-gray-700">
                <button id="tab-login" onclick="toggleAuth('login')"
                    class="flex-1 pb-2 text-sm font-bold text-center tab-active transition">INICIAR SESIÓN</button>
                <button id="tab-register" onclick="toggleAuth('register')"
                    class="flex-1 pb-2 text-sm font-bold text-center tab-inactive transition">REGISTRARSE</button>
            </div>

            <!-- FORMULARIO LOGIN -->
            <form id="form-login" th:action="@{/login}" method="post" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Usuario</label>
                    <input type="text" name="username"
                        class="w-full bg-gray-800 border border-gray-700 rounded py-2 px-4 focus:border-blue-500 text-white outline-none"
                        required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Contraseña</label>
                    <input type="password" name="password"
                        class="w-full bg-gray-800 border border-gray-700 rounded py-2 px-4 focus:border-blue-500 text-white outline-none"
                        required>
                </div>
                <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded shadow-lg transition">ENTRAR</button>
            </form>

            <!-- FORMULARIO REGISTRO -->
            <form id="form-register" th:action="@{/register}" method="post" class="space-y-4 hidden-form">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Nuevo Usuario</label>
                    <input type="text" name="username"
                        class="w-full bg-gray-800 border border-gray-700 rounded py-2 px-4 focus:border-purple-500 text-white outline-none"
                        required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Crear Contraseña</label>
                    <input type="password" name="password"
                        class="w-full bg-gray-800 border border-gray-700 rounded py-2 px-4 focus:border-purple-500 text-white outline-none"
                        required>
                </div>
                <button type="submit"
                    class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded shadow-lg transition">CREAR
                    CUENTA</button>
            </form>

            <!-- ELIMINADO: Bloque 'Solo quieres probar' con enlaces a Demo -->

        </div>

        <!-- ========================================== -->
        <!-- VISTA USUARIO (DASHBOARD CON LISTA DE SALAS) -->
        <!-- ========================================== -->
        <div sec:authorize="isAuthenticated()" class="w-full max-w-5xl grid grid-cols-1 md:grid-cols-4 gap-6">

            <!-- Tarjeta Perfil (Columna 1) -->
            <div class="glass-panel p-6 rounded-xl flex flex-col items-center text-center md:col-span-1">
                <div
                    class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-3xl font-bold mb-4 floating">
                    <span th:text="${#authentication.name.substring(0,1)}">U</span>
                </div>
                <h2 class="text-xl font-bold text-white" th:text="${#authentication.name}">User</h2>
                <p class="text-xs text-gray-400 mt-1">Dueño de <span th:text="${#lists.size(myRooms)}">0</span> salas
                </p>

                <!-- Botón Crear Sala (Abre modal) -->
                <button onclick="document.getElementById('modal-create').classList.remove('hidden')"
                    class="mt-4 w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded font-bold text-sm">
                    <i class="fa-solid fa-plus mr-1"></i> Crear Sala
                </button>
            </div>

            <div class="md:col-span-3 grid grid-cols-1 gap-6">

                <div class="glass-panel p-4 rounded-xl flex flex-col">
                    <h3 class="text-lg font-bold text-blue-400 border-b border-gray-700 pb-2 mb-3">
                        <i class="fa-solid fa-hammer mr-2"></i> Mis Creaciones
                    </h3>
                    <div class="max-h-64 overflow-y-auto pr-2 custom-scroll">
                        <div th:if="${#lists.isEmpty(myRooms)}" class="text-gray-500 italic text-sm">No has creado
                            ninguna sala.</div>
                        <div th:each="room : ${myRooms}"
                            class="flex justify-between items-center bg-gray-800/50 p-3 rounded mb-2 border-l-4 border-blue-500/50 hover:bg-gray-800">
                            <div>
                                <div class="font-bold" th:text="${room.name}">Nombre de Sala</div>
                                <div class="text-xs text-gray-400" th:text="${room.id}"></div>
                            </div>
                            <div class="flex gap-2">
                                <a th:href="@{/editor(room=${room.name})}"
                                    class="bg-purple-600 hover:bg-purple-500 text-white px-2 py-1 rounded text-xs font-bold">Editar</a>
                                <a th:href="@{/play(room=${room.name})}"
                                    class="bg-green-600 hover:bg-green-500 text-white px-2 py-1 rounded text-xs font-bold">Jugar</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-4 rounded-xl flex flex-col">
                    <h3 class="text-lg font-bold text-green-400 border-b border-gray-700 pb-2 mb-3">
                        <i class="fa-solid fa-globe mr-2"></i> Salas Disponibles
                    </h3>
                    <div class="max-h-64 overflow-y-auto pr-2 custom-scroll">
                        <div th:if="${#lists.isEmpty(publicRooms)}" class="text-gray-500 italic text-sm">No hay salas
                            públicas disponibles.</div>
                        <div th:each="room : ${publicRooms}"
                            class="flex justify-between items-center bg-gray-800/50 p-3 rounded mb-2 hover:bg-gray-800">
                            <div>
                                <div class="font-bold" th:text="${room.name}">Sala Pública</div>
                                <div class="text-xs text-gray-400" th:text="${room.id}"></div>
                            </div>
                            <a th:href="@{/play(room=${room.name})}"
                                class="bg-green-700 hover:bg-green-600 text-white px-2 py-1 rounded text-xs font-bold">Unirse</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- MODAL CREAR SALA -->
    <div id="modal-create"
        class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-[#161b22] p-6 rounded-xl border border-gray-700 w-96 shadow-2xl relative">
            <button onclick="document.getElementById('modal-create').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-500 hover:text-white">X</button>
            <h3 class="text-white text-xl font-bold mb-4">Nueva Sala</h3>
            <!-- Formulario apunta al nuevo controlador POST /create_room -->
            <form th:action="@{/create_room}" method="post">
                <input type="text" name="name" placeholder="Nombre de la Sala"
                    class="w-full bg-[#0d1117] text-white border border-gray-700 p-3 rounded mb-4 outline-none focus:border-green-500"
                    required>
                <input type="password" name="password" placeholder="Contraseña (Opcional)"
                    class="w-full bg-[#0d1117] text-white border border-gray-700 p-3 rounded mb-6 outline-none focus:border-green-500">
                <button type="submit"
                    class="w-full bg-green-600 hover:bg-green-500 text-white py-3 rounded-lg font-bold shadow-lg">Crear</button>
            </form>
        </div>
    </div>

    <footer class="text-center p-4 text-xs text-gray-600 relative z-10">
        &copy; 2024 EngineIO
    </footer>

    <script>
        // Función JS para alternar pestañas de login/registro
        function toggleAuth(mode) {
            const loginForm = document.getElementById('form-login');
            const registerForm = document.getElementById('form-register');
            const tabLogin = document.getElementById('tab-login');
            const tabRegister = document.getElementById('tab-register');

            if (mode === 'login') {
                loginForm.classList.remove('hidden-form');
                registerForm.classList.add('hidden-form');
                tabLogin.className = 'flex-1 pb-2 text-sm font-bold text-center tab-active transition';
                tabRegister.className = 'flex-1 pb-2 text-sm font-bold text-center tab-inactive transition';
            } else {
                loginForm.classList.add('hidden-form');
                registerForm.classList.remove('hidden-form');
                tabLogin.className = 'flex-1 pb-2 text-sm font-bold text-center tab-inactive transition';
                tabRegister.className = 'flex-1 pb-2 text-sm font-bold text-center tab-active transition';
            }
        }
    </script>
</body>

</html>