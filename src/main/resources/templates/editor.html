<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>

    <style>
        :root {
            --bg-main: #0a0f18;
            --bg-panel: rgba(30, 41, 59, 0.7);
            --accent: #3b82f6;
            --neon-blue: #00f2ff;
            --neon-purple: #bc13fe;
            --border-color: #334155;
            --text-dim: #94a3b8;
        }

        body {
            background-color: var(--bg-main);
            background-image:
                radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(188, 19, 254, 0.05) 0%, transparent 40%);
            color: #f1f5f9;
        }

        /* Navbar con efecto de cristal */
        nav {
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        /* Contenedor de Editor */
        .editor-container {
            background: var(--bg-panel);
            backdrop-filter: blur(4px);
            border: 1px solid var(--border-color);
            border-radius: 0 0 12px 12px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .editor-container:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }

        /* Encabezados de Panel */
        .panel-header {
            background: linear-gradient(90deg, #1e293b 0%, #334155 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 8px 14px;
            letter-spacing: 0.05em;
            font-size: 10px;
        }

        /* Estilo del código (Prism) */
        .code-editor {
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace !important;
            font-size: 13px;
            line-height: 1.6;
            caret-color: var(--neon-blue);
            /* Cursor neón */
        }

        /* Personalización de colores de Prism para el tema oscuro */
        .token.function {
            color: #7dd3fc;
        }

        .token.keyword {
            color: #f472b6;
        }

        .token.string {
            color: #a2f675;
        }

        .token.comment {
            color: #64748b;
            font-style: italic;
        }

        .token.operator {
            color: #94a3b8;
        }

        .token.number {
            color: #fbbf24;
        }

        /* Scrollbars Estilo Gamer */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Botones con Glow */
        #btn-publish {
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #btn-reset:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }

        /* Paneles Laterales (Soon) */
        .soon-panel {
            border: 1px dashed rgba(148, 163, 184, 0.2);
            background: rgba(15, 23, 42, 0.3);
        }
    </style>
</head>

<body th:data-room-id="${roomId}" th:data-api-base="${ApiBaseUrl}">

    <nav class="h-14 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-layer-group text-blue-500 text-xl"></i>
            <h1 class="font-bold text-lg tracking-wide">ENGINE<span class="font-light text-slate-400">STUDIO</span></h1>
            <span class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-500 ml-2" th:text="${roomId}">ROOM_ID</span>
        </div>
        <button id="btn-reset" onclick="resetState()"
            class="bg-slate-800 hover:bg-red-900 text-slate-400 hover:text-white px-4 py-2 rounded-md text-sm font-bold transition-all flex items-center gap-2 border border-slate-700">
            <i class="fa-solid fa-trash-can"></i> LIMPIAR DB
        </button>
        <button id="btn-publish" onclick="publish()"
            class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-md text-sm font-bold shadow-lg transition-all flex items-center gap-2">
            <i class="fa-solid fa-cloud-arrow-up"></i> PUBLICAR CAMBIOS
        </button>
    </nav>

    <main class="flex-1 p-4 grid grid-cols-12 gap-4 h-full min-h-0">
        <section class="col-span-9 grid grid-cols-2 grid-rows-2 gap-4 h-full min-h-0">
            <div class="flex flex-col h-full min-h-0">
                <div class="panel-header"><span><i class="fa-solid fa-server mr-2"></i>Lógica Servidor</span><span
                        class="badge badge-server">JS</span></div>
                <div class="editor-container">
                    <div id="ed-logic" class="code-editor language-javascript" th:text="${serverLogic}"></div>
                </div>
            </div>
            <div class="flex flex-col h-full min-h-0">
                <div class="panel-header"><span><i class="fa-brands fa-html5 mr-2"></i>Estructura UI</span><span
                        class="badge badge-client">HTML</span></div>
                <div class="editor-container">
                    <div id="ed-structure" class="code-editor language-javascript" th:text="${clientStructureHtml}">
                    </div>

                </div>
            </div>
            <div class="flex flex-col h-full min-h-0">
                <div class="panel-header"><span><i class="fa-solid fa-paint-roller mr-2"></i>Renderizado</span><span
                        class="badge badge-client">JS</span></div>
                <div class="editor-container">
                    <div id="ed-render" class="code-editor language-javascript" th:text="${clientRenderScript}"></div>
                </div>

            </div>
            <div class="flex flex-col h-full min-h-0">
                <div class="panel-header"><span><i class="fa-solid fa-gamepad mr-2"></i>Input & Control</span><span
                        class="badge badge-client">JS</span></div>
                <div class="editor-container">
                    <div id="ed-input" class="code-editor language-javascript" th:text="${clientInputScript}"></div>
                </div>

            </div>
        </section>

        <section class="col-span-3 flex flex-col gap-4 h-full">
            <div class="h-1/2 flex flex-col">
                <div class="bg-slate-800 p-2 rounded-t text-xs font-bold text-slate-400 uppercase">Assets</div>
                <div class="soon-panel flex-1">
                    <div class="text-center"><i class="fa-solid fa-box-open text-4xl mb-2 opacity-50"></i>
                        <div class="text-sm opacity-50">Próximamente</div>
                    </div>
                </div>
            </div>
            <div class="h-1/2 flex flex-col">
                <div class="bg-slate-800 p-2 rounded-t text-xs font-bold text-slate-400 uppercase">Consola</div>
                <div class="soon-panel flex-1">
                    <div class="text-center"><i class="fa-solid fa-terminal text-4xl mb-2 opacity-50"></i>
                        <div class="text-sm opacity-50">Próximamente</div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <script>
        // Definimos esto GLOBALMENTE para que funcione en resetState y en el módulo
        window.API_URL = document.body.dataset.apiBase || "http://localhost:3000";
        window.ROOM_ID = document.body.dataset.roomId;
        async function resetState() {
            if (!confirm("¿Estás seguro? Se borrará el estado persistente (DB) de esta sala.")) return;

            const btn = document.getElementById('btn-reset');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> BORRANDO...';

            try {
                const res = await fetch(window.API_URL + '/api/reset-room-state', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId: ROOM_ID })
                });

                if (res.ok) {
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> DB LIMPIA';
                    btn.classList.add('text-emerald-500');
                    setTimeout(() => location.reload(), 1000); // Recargamos para ver cambios
                }else {
                    throw new Error('Server error');
                }
            } catch (e) {
                btn.innerHTML = '<i class="fa-solid fa-xmark"></i> ERROR';
            }
        }
    </script>
    <script type="module">
        

        // Importamos la librería directamente desde la CDN como módulo
        import { CodeJar } from 'https://medv.io/codejar/codejar.js';
        let jarLogic, jarStructure, jarRender, jarInput;
        window.onload = () => {
            // Verificar si CodeJar cargó
            if (typeof CodeJar === 'undefined') {
                console.error("❌ Error: CodeJar no se cargó. Revisa tu conexión o la URL de la CDN.");
                return;
            }

            // Función de resaltado
            const highlight = (editor) => {
                const isHTML = editor.classList.contains('language-markup');
                const lang = isHTML ? 'markup' : 'javascript';
                const code = editor.textContent;
                editor.innerHTML = Prism.highlight(code, Prism.languages[lang], lang);
            };

            // Función de configuración
            const setup = (id) => {
                const el = document.getElementById(id);
                const initialCode = el.textContent;
                el.innerHTML = ""; // Limpieza de seguridad

                const jar = CodeJar(el, highlight);
                jar.updateCode(initialCode);
                return jar;
            };

            // Inicialización al cargar la página
            try {
                jarLogic = setup('ed-logic');
                jarStructure = setup('ed-structure');
                jarRender = setup('ed-render');
                jarInput = setup('ed-input');

                // Exportar a window para que tu función publish() pueda verlos
                window.jars = { jarLogic, jarStructure, jarRender, jarInput };
                console.log("✅ Editores vinculados mediante Módulo ESM.");
            } catch (e) {
                console.error("❌ Error inicializando editores:", e);
            }
        };


        // Ajustamos tu función publish para leer de window.jars
        window.publish = async () => {
            const btn = document.getElementById('btn-publish');
            const originalHTML = btn.innerHTML;

            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> GUARDANDO...';
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            const payload = {
                roomId: document.body.dataset.roomId,
                serverLogic: window.jars.jarLogic.toString(),
                clientStructureHtml: window.jars.jarStructure.toString(),
                clientRenderScript: window.jars.jarRender.toString(),
                clientInputScript: window.jars.jarInput.toString()
            };

            try {
                const res = await fetch(window.API_URL + '/api/publish-room', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error("Error Server");

                btn.innerHTML = '<i class="fa-solid fa-check"></i> PUBLICADO';
                btn.classList.replace('bg-blue-600', 'bg-emerald-600');
                btn.classList.replace('hover:bg-blue-500', 'hover:bg-emerald-500');

                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.replace('bg-emerald-600', 'bg-blue-600');
                    btn.classList.replace('hover:bg-emerald-500', 'hover:bg-blue-500');
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                }, 2000);

            } catch (e) {
                console.error(e);
                btn.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> ERROR';
                btn.classList.replace('bg-blue-600', 'bg-red-600');
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.replace('bg-red-600', 'bg-blue-600');
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                }, 2000);
            }
        }
    </script>


</body>


</html>