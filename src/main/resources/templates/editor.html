<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Engine IO - Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #0f172a;
            color: #cbd5e1;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.9);
            border-bottom: 1px solid #334155;
        }

        /* Editor de Lógica Principal */
        .code-area {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            resize: none;
            border: none;
            outline: none;
            width: 100%;
            height: 100%;
        }

        /* Paneles de Diseño (Estructura, Render, Input) */
        .design-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        .design-section {
            flex: 1; /* Esto hace que cada una de las 3 partes crezca equitativamente */
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #334155;
            min-height: 0; /* Evita que el flexbox se desborde */
        }

        .design-label {
            background: #252526;
            padding: 4px 12px;
            font-size: 11px;
            font-weight: bold;
            color: #858585;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }

        .code-area-small {
            flex-grow: 1;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            padding: 8px;
            resize: none;
            outline: none;
            border: none;
        }

        .tab-active {
            background: #1e1e1e;
            border-top: 2px solid #3b82f6;
            color: white;
        }

        .tab-inactive {
            background: #2d2d2d;
            color: #6b7280;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

    </style>
</head>

<body th:data-room-id="${roomId}" 
      th:data-current-username="${currentUsername}" 
      th:data-room-owner="${roomOwner}" 
      th:data-api-base="${ApiBaseUrl}">

    <header class="h-14 glass-panel flex items-center justify-between px-4 shrink-0 z-20">
        <div class="flex items-center gap-4">
            <a href="/" class="text-gray-400 hover:text-white font-bold text-sm"><i class="fa-solid fa-arrow-left"></i> SALIR</a>
            <div class="h-6 w-px bg-gray-600"></div>
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-cube text-blue-500"></i>
                <span class="font-bold text-gray-200">Studio</span>
                <span class="text-xs bg-gray-700 px-2 rounded" th:text="${currentUsername ?: 'Invitado'}">User</span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <span id="status-text" class="text-xs text-green-400 font-mono mr-2">Online</span>
            <button onclick="saveLocal()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs"><i class="fa-solid fa-floppy-disk"></i> Local</button>
            <button id="btn-pub" onclick="publish()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1 rounded text-sm font-bold"><i class="fa-solid fa-cloud-arrow-up"></i> PUBLICAR</button>
            <button onclick="runSim()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-1 rounded text-sm font-bold"><i class="fa-solid fa-play"></i> TEST</button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <div class="flex-1 flex flex-col min-w-0 bg-[#1e1e1e]">
            <div class="flex bg-[#252526] text-xs select-none shrink-0">
                <div id="tab-logic" onclick="setTab('logic')" class="px-6 py-2 cursor-pointer tab-active">logic.js</div>
                <div id="tab-design" onclick="setTab('design')" class="px-6 py-2 cursor-pointer tab-inactive">design.html (Estructura / Render / Input)</div>
            </div>

            <div class="flex-1 relative overflow-hidden">
                <textarea id="ed-logic" class="code-area p-4 text-sm absolute inset-0" spellcheck="false" oninput="dirty()" th:text="${serverLogic}"></textarea>

                <div id="design-editor" class="design-panel absolute inset-0 hidden">
                    
                    <div class="design-section">
                        <div class="design-label">1. Estructura (HTML / CSS)</div>
                        <textarea id="ed-structure" class="code-area-small" spellcheck="false" oninput="dirty()" th:utext="${clientStructureHtml}"></textarea>
                    </div>

                    <div class="design-section">
                        <div class="design-label">2. Renderizado (onRender)</div>
                        <textarea id="ed-render" class="code-area-small" spellcheck="false" oninput="dirty()" th:text="${clientRenderScript}"></textarea>
                    </div>

                    <div class="design-section">
                        <div class="design-label">3. Entrada (Input / Events)</div>
                        <textarea id="ed-input" class="code-area-small" spellcheck="false" oninput="dirty()" th:text="${clientInputScript}"></textarea>
                    </div>

                </div>
            </div>
        </div>

        <div class="w-96 bg-[#0f1115] border-l border-gray-700 flex flex-col hidden lg:flex shrink-0">
            <div class="h-1/2 flex flex-col border-b border-gray-700">
                <div class="p-2 bg-gray-800 text-[10px] font-bold text-gray-400 uppercase">Live Preview</div>
                <div id="preview-stage" class="flex-1 relative overflow-hidden bg-black"></div>
            </div>
            <div class="flex-1 flex flex-col min-h-0">
                <div class="p-2 bg-gray-800 text-[10px] font-bold text-gray-400 uppercase">State Inspector</div>
                <div class="flex-1 p-2 overflow-auto font-mono text-xs">
                    <pre id="json-view" class="text-green-500"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- ENGINE LOGIC -->
    <script>
        // Leer variables de los atributos data- en el body
        const body = document.body;
        const ROOM_ID = body.dataset.roomId || null;
        const USER_NAME = body.dataset.currentUsername || null;
        const ROOM_OWNER = body.dataset.roomOwner || null;
        // ***************************************************************
        // 1. OBTENER LA URL BASE DE LA API DE NODE.JS (Ej. Render URL)
        // ***************************************************************
        const API_BASE_URL = body.dataset.apiBase || 'http://localhost:3000'; // Fallback a localhost
        console.log('API_BASE_URL:', API_BASE_URL);
        console.log('room_ID:', ROOM_ID);
        console.log('user_NAME:', USER_NAME);
        console.log('room_OWNER:', ROOM_OWNER);

        // NOTE: El acceso a la base de datos y la clave de Supabase ya no se hace desde el frontend.
        // Se delega al servidor mediante un endpoint POST /api/publish-room.

        let state = { tick: 0, jugadores: [], mapa: {} };
        let logicFn = { onUpdate: null, onInput: null, onBot: null, botConfig: { count: 0 } }, renderFn = null;

        function setTab(t) {
            document.getElementById('ed-logic').classList.toggle('hidden', t !== 'logic');
            document.getElementById('design-editor').classList.toggle('hidden', t !== 'design');

            const logicTab = document.getElementById('tab-logic');
            const designTab = document.getElementById('tab-design');

            logicTab.className = t === 'logic' ? 'px-4 py-2 cursor-pointer tab-active' : 'px-4 py-2 cursor-pointer tab-inactive';
            designTab.className = t === 'design' ? 'px-4 py-2 cursor-pointer tab-active' : 'px-4 py-2 cursor-pointer tab-inactive';
        }

        window.SIM_emit = function (pl) { /* ... (sim logic) ... */ };
        function runSim() { /* ... (sim logic) ... */ };
        function checkPermissions() { /* ... (permission logic) ... */ };

        // --- PUBLICAR (AHORA VIA SERVER) ---
        async function publish() {
            if (!USER_NAME || USER_NAME !== ROOM_OWNER) {
                alert("Permiso denegado: Solo el dueño puede publicar.");
                return;
            }

            const btn = document.getElementById('btn-pub');
            btn.innerHTML = 'Subiendo...';

            const serverLogic = document.getElementById('ed-logic').value;
            const structure = document.getElementById('ed-structure').value;
            const renderScript = document.getElementById('ed-render').value;
            const inputScript = document.getElementById('ed-input').value;

            // ELIMINADO EL ENSAMBLAJE clientHtmlFinal AQUÍ EN EL FRONTEND

            try {
                // ***************************************************************
                // 2. LA LLAMADA FETCH AHORA USA LA VARIABLE DE ENTORNO
                // ***************************************************************
                const resp = await fetch(`${API_BASE_URL}/api/publish-room`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        roomId: ROOM_ID,
                        serverLogic: serverLogic,
                        clientStructureHtml: structure,
                        clientRenderScript: renderScript,
                        clientInputScript: inputScript
                    })
                });

                if (!resp.ok) {
                    const txt = await resp.text();
                    alert('Error servidor: ' + txt);
                    btn.innerHTML = 'ERROR';
                    return;
                }

                // Respuesta correcta
                runSim();
                btn.innerHTML = '✔ PUBLICADO'; setTimeout(() => btn.innerHTML = 'PUBLICAR', 2000);
            } catch (e) {
                alert('Error de red: ' + e.message);
                btn.innerHTML = 'ERROR';
            }
        }

        function loadContent() {
            // El contenido ya está inyectado directamente en los textareas por Thymeleaf
            checkPermissions();
            if (ROOM_ID) runSim();
        }

        function saveLocal() {
            localStorage.setItem('logic_' + ROOM_ID, document.getElementById('ed-logic').value);
            localStorage.setItem('structure_' + ROOM_ID, document.getElementById('ed-structure').value);
            localStorage.setItem('render_' + ROOM_ID, document.getElementById('ed-render').value);
            localStorage.setItem('input_' + ROOM_ID, document.getElementById('ed-input').value);
        }
        function dirty() { document.getElementById('status-text').innerText = "Changes..."; }

        // Cargar desde local storage si existe (para desarrollo)
        if (localStorage.getItem('logic_' + ROOM_ID)) document.getElementById('ed-logic').value =
            localStorage.getItem('logic_' + ROOM_ID);
        if (localStorage.getItem('structure_' + ROOM_ID)) document.getElementById('ed-structure').value =
            localStorage.getItem('structure_' + ROOM_ID);
        if (localStorage.getItem('render_' + ROOM_ID)) document.getElementById('ed-render').value =
            localStorage.getItem('render_' + ROOM_ID);
        if (localStorage.getItem('input_' + ROOM_ID)) document.getElementById('ed-input').value =
            localStorage.getItem('input_' + ROOM_ID);


        window.onload = loadContent;

    </script>
</body>

</html>